<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Executing Unmanaged Code in Memory" /><meta property="og:locale" content="en" /><meta name="description" content="Difference between P/Invoke &amp; D/Invoke" /><meta property="og:description" content="Difference between P/Invoke &amp; D/Invoke" /><link rel="canonical" href="https://coppertop-6.github.io//posts/ExecutingCode/" /><meta property="og:url" content="https://coppertop-6.github.io//posts/ExecutingCode/" /><meta property="og:site_name" content="H4ck1ng, L3@rn1ng, 8logg1ng @nd $tuff" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-02-08T19:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Executing Unmanaged Code in Memory" /><meta name="twitter:site" content="@coppertop109" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-02-10T08:30:06+02:00","datePublished":"2023-02-08T19:00:00+02:00","description":"Difference between P/Invoke &amp; D/Invoke","headline":"Executing Unmanaged Code in Memory","mainEntityOfPage":{"@type":"WebPage","@id":"https://coppertop-6.github.io//posts/ExecutingCode/"},"url":"https://coppertop-6.github.io//posts/ExecutingCode/"}</script><title>Executing Unmanaged Code in Memory | H4ck1ng, L3@rn1ng, 8logg1ng @nd $tuff</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="H4ck1ng, L3@rn1ng, 8logg1ng @nd $tuff"><meta name="application-name" content="H4ck1ng, L3@rn1ng, 8logg1ng @nd $tuff"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://pbs.twimg.com/profile_images/1022073030623875072/BPpIFFkL_400x400.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">H4ck1ng, L3@rn1ng, 8logg1ng @nd $tuff</a></div><div class="site-subtitle font-italic">Imposter syndrome is real...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/coppertop-6" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/coppertop109" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['why','nomail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Executing Unmanaged Code in Memory</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Executing Unmanaged Code in Memory</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1675875600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 8, 2023 </em> </span> <span> Updated <em class="" data-ts="1676010606" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 10, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/coppertop109">TBA</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1042 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><h1 id="difference-between-pinvoke--dinvoke">Difference between P/Invoke &amp; D/Invoke</h1><p>With the ever increasing effectiveness of detection tools on the Blue Team side, more sophisticated ways of executing unmanaged code is needed on the Red Team side. Powershell has long been a go-to for Red Teamers, but has also been heavily scrutinized by detective capabilities and, as such, much of the Offensive tradecraft has moved over to the flexibility that .NET provides. Two such mechanisms have gained popularity over the years and, in this post, I will attempt to explain the difference between the two mechanisms.</p><h1 id="pinvoke---platform-invoke">P/Invoke - Platform Invoke</h1><p>P/Invoke allows .NET applications to access structs, callbacks, and functions in unmanaged libraries (DLLs). One of the main reasons that .NET has become popular with Offensive tool developers is that .NET assemblies are easy to load and execute from memory which means that as a Red Team Operator with initial access, there is no need to touch disk while executing advanced post-exploitation activities.</p><p>Something to consider, i.t.o detection, when using P/Invoke:</p><p>When a .NET assembly is loaded, the Import Address Table will be updated to include the memory addresses of the API calls and functions that are called by the assembly (Static Reference). For example, if you make use of P/Invoke to call CreateRemoteThread, then your executable’s import address table will include a static reference to that function. This is easy to view from a defensive perspective when analyzing the executable and will clearly show that you are making a malicious call to a remote process. Any endpoint security product monitoring API calls, through API Hooking, on the endpoint will catch any call made through P/Invoke. More advanced Endpoint Detection and Response tools may also easily block these malicious looking calls.</p><h1 id="dinvoke---dynamic-invoke">D/Invoke - Dynamic Invoke</h1><p>D/Invoke contrasts the P/Invoke method by dynamically referencing the function addresses. The application has to manually look for the memory address of each function. This is accomplished by loading DLLs into memory manually through whatever mechanism the red team operator prefers. Once the DLL is loaded into memory, all that is left is to get a pointer to a function in the DLL and calling that function using the pointer.</p><p>The actual .NET feature that allows this is called delegates. ‘Delegates are used to pass methods as arguments to other methods’. The Delegate API allows the wrapping of a method/function in a class. The distinctive feature of delegates is that they can be instantiated from a pointer to a function and dynamically invoking said function while passing in parameters.</p><p>As an example, from the SharpSploit toolkit:</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">object</span> <span class="nf">DynamicAPIInvoke</span><span class="p">(</span><span class="kt">string</span> <span class="n">DLLName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">FunctionName</span><span class="p">,</span> <span class="n">Type</span> <span class="n">FunctionDelegateType</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">Parameters</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">IntPtr</span> <span class="n">pFunction</span> <span class="p">=</span> <span class="nf">GetLibraryAddress</span><span class="p">(</span><span class="n">DLLName</span><span class="p">,</span> <span class="n">FunctionName</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">DynamicFunctionInvoke</span><span class="p">(</span><span class="n">pFunction</span><span class="p">,</span> <span class="n">FunctionDelegateType</span><span class="p">,</span> <span class="k">ref</span> <span class="n">Parameters</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="kt">object</span> <span class="nf">DynamicFunctionInvoke</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">FunctionPointer</span><span class="p">,</span> <span class="n">Type</span> <span class="n">FunctionDelegateType</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">Parameters</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Delegate</span> <span class="n">funcDelegate</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">GetDelegateForFunctionPointer</span><span class="p">(</span><span class="n">FunctionPointer</span><span class="p">,</span> <span class="n">FunctionDelegateType</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">funcDelegate</span><span class="p">.</span><span class="nf">DynamicInvoke</span><span class="p">(</span><span class="n">Parameters</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The second method is the core of the D/Invoke API. It creates a Delegate from a function pointer (funcDelegate) and invokes the function wrapped by the delegate (funcDelegate.DynamicInvoke), passing in your parameter (Parameters). The parameters are passed as an array of Objects (ref object[] Parameters) which provides the flexibility of passing data in any form needed. The only consideration is that the data needs to be structured in the way the unmanaged DLL expects it to be.</p><p>The most difficult part to understand is the Type FunctionDelegateType parameter. This is where you pass in the function prototype of the unmanaged code that you want to call. The prototype is the instructions for the delegate on how to structure the the CPU registers and the memory stack when the function is invoked. Defining a delegate works in a similar manner. You can define a delegate similar to how you would define a variable. Optionally, you can specify what calling convention to use when calling the function wrapped by the delegate.</p><p>Here is an example of a FunctionDelegateType for the NtCreateThreadEx API:</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">UnmanagedFunctionPointer</span><span class="p">(</span><span class="n">CallingConvention</span><span class="p">.</span><span class="n">StdCall</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">delegate</span> <span class="n">Execute</span><span class="p">.</span><span class="n">Native</span><span class="p">.</span><span class="n">NTSTATUS</span> <span class="nf">NtCreateThreadEx</span><span class="p">(</span>
    <span class="k">out</span> <span class="n">IntPtr</span> <span class="n">threadHandle</span><span class="p">,</span>
    <span class="n">Execute</span><span class="p">.</span><span class="n">Win32</span><span class="p">.</span><span class="n">WinNT</span><span class="p">.</span><span class="n">ACCESS_MASK</span> <span class="n">desiredAccess</span><span class="p">,</span>
    <span class="n">IntPtr</span> <span class="n">objectAttributes</span><span class="p">,</span>
    <span class="n">IntPtr</span> <span class="n">processHandle</span><span class="p">,</span>
    <span class="n">IntPtr</span> <span class="n">startAddress</span><span class="p">,</span>
    <span class="n">IntPtr</span> <span class="n">parameter</span><span class="p">,</span>
    <span class="kt">bool</span> <span class="n">createSuspended</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">stackZeroBits</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">sizeOfStack</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">maximumStackSize</span><span class="p">,</span>
    <span class="n">IntPtr</span> <span class="n">attributeList</span><span class="p">);</span>
    
</pre></table></code></div></div><p>There is already a library of delegates and function wrappers for commonly used NT and Win32 APIs.</p><p>Using this dynamic loading technique removes the detection considerations present with P/Invoke as there are no suspicious API calls in the IAT of your Assembly.</p><h1 id="in-practise">In Practise</h1><p>SharpSploit now has a DInvoke library in the SharpSploit.Execution.DynamicInvoke namespace. The DInvoke library provides a managed wrapper function for each unmanaged function. The wrapper helps the user by ensuring that parameters are passed in correctly and the correct type of object is returned.</p><p>The code below demonstrates how DInvoke is used for the NtCreateThreadEx function in ntdll.dll. The delegate (that sets up the function prototype) is stored in the SharpSploit.Execution.DynamicInvoke.Native.DELEGATES struct. The wrapper method is SharpSploit.Execution.DynamicInvoke.Native.NtCreateThreadEx that takes all of the same parameters that you would expect to use in a normal PInvoke.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="k">namespace</span> <span class="nn">SharpSploit.Execution.DynamicInvoke</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Contains function prototypes and wrapper functions for dynamically invoking NT API Calls.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Native</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="n">Execute</span><span class="p">.</span><span class="n">Native</span><span class="p">.</span><span class="n">NTSTATUS</span> <span class="nf">NtCreateThreadEx</span><span class="p">(</span>
            <span class="k">ref</span> <span class="n">IntPtr</span> <span class="n">threadHandle</span><span class="p">,</span>
            <span class="n">Execute</span><span class="p">.</span><span class="n">Win32</span><span class="p">.</span><span class="n">WinNT</span><span class="p">.</span><span class="n">ACCESS_MASK</span> <span class="n">desiredAccess</span><span class="p">,</span>
            <span class="n">IntPtr</span> <span class="n">objectAttributes</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">processHandle</span><span class="p">,</span>
            <span class="n">IntPtr</span> <span class="n">startAddress</span><span class="p">,</span>
            <span class="n">IntPtr</span> <span class="n">parameter</span><span class="p">,</span>
            <span class="kt">bool</span> <span class="n">createSuspended</span><span class="p">,</span>
            <span class="kt">int</span> <span class="n">stackZeroBits</span><span class="p">,</span>
            <span class="kt">int</span> <span class="n">sizeOfStack</span><span class="p">,</span>
            <span class="kt">int</span> <span class="n">maximumStackSize</span><span class="p">,</span>
            <span class="n">IntPtr</span> <span class="n">attributeList</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Craft an array for the arguments</span>
            <span class="kt">object</span><span class="p">[]</span> <span class="n">funcargs</span> <span class="p">=</span>
            <span class="p">{</span>
                <span class="n">threadHandle</span><span class="p">,</span> <span class="n">desiredAccess</span><span class="p">,</span> <span class="n">objectAttributes</span><span class="p">,</span> <span class="n">processHandle</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">createSuspended</span><span class="p">,</span> <span class="n">stackZeroBits</span><span class="p">,</span>
                <span class="n">sizeOfStack</span><span class="p">,</span> <span class="n">maximumStackSize</span><span class="p">,</span> <span class="n">attributeList</span>
            <span class="p">};</span>

            <span class="n">Execute</span><span class="p">.</span><span class="n">Native</span><span class="p">.</span><span class="n">NTSTATUS</span> <span class="n">retValue</span> <span class="p">=</span> <span class="p">(</span><span class="n">Execute</span><span class="p">.</span><span class="n">Native</span><span class="p">.</span><span class="n">NTSTATUS</span><span class="p">)</span><span class="n">Generic</span><span class="p">.</span><span class="nf">DynamicAPIInvoke</span><span class="p">(</span><span class="s">@"ntdll.dll"</span><span class="p">,</span> <span class="s">@"NtCreateThreadEx"</span><span class="p">,</span>
                <span class="k">typeof</span><span class="p">(</span><span class="n">DELEGATES</span><span class="p">.</span><span class="n">NtCreateThreadEx</span><span class="p">),</span> <span class="k">ref</span> <span class="n">funcargs</span><span class="p">);</span>

            <span class="c1">// Update the modified variables</span>
            <span class="n">threadHandle</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)</span><span class="n">funcargs</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>

            <span class="k">return</span> <span class="n">retValue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">struct</span> <span class="nc">DELEGATES</span>
        <span class="p">{</span>
            <span class="p">[</span><span class="nf">UnmanagedFunctionPointer</span><span class="p">(</span><span class="n">CallingConvention</span><span class="p">.</span><span class="n">StdCall</span><span class="p">)]</span>
            <span class="k">public</span> <span class="k">delegate</span> <span class="n">Execute</span><span class="p">.</span><span class="n">Native</span><span class="p">.</span><span class="n">NTSTATUS</span> <span class="nf">NtCreateThreadEx</span><span class="p">(</span>
                <span class="k">out</span> <span class="n">IntPtr</span> <span class="n">threadHandle</span><span class="p">,</span>
                <span class="n">Execute</span><span class="p">.</span><span class="n">Win32</span><span class="p">.</span><span class="n">WinNT</span><span class="p">.</span><span class="n">ACCESS_MASK</span> <span class="n">desiredAccess</span><span class="p">,</span>
                <span class="n">IntPtr</span> <span class="n">objectAttributes</span><span class="p">,</span>
                <span class="n">IntPtr</span> <span class="n">processHandle</span><span class="p">,</span>
                <span class="n">IntPtr</span> <span class="n">startAddress</span><span class="p">,</span>
                <span class="n">IntPtr</span> <span class="n">parameter</span><span class="p">,</span>
                <span class="kt">bool</span> <span class="n">createSuspended</span><span class="p">,</span>
                <span class="kt">int</span> <span class="n">stackZeroBits</span><span class="p">,</span>
                <span class="kt">int</span> <span class="n">sizeOfStack</span><span class="p">,</span>
                <span class="kt">int</span> <span class="n">maximumStackSize</span><span class="p">,</span>
                <span class="n">IntPtr</span> <span class="n">attributeList</span><span class="p">);</span>
        <span class="p">}</span>
</pre></table></code></div></div><p>Hopefully this clarified the difference between these popular techniques and what to keep in mind when using them.</p><p>https://thewover.github.io/Dynamic-Invoke/ https://learn.microsoft.com/en-us/dotnet/standard/native-interop/pinvoke https://github.com/cobbr/SharpSploit</p><p>Post written by: <em>J33r4ff3</em></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blog/'>blog</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/code-execution/" class="post-tag no-text-decoration" >code_execution</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Executing+Unmanaged+Code+in+Memory+-+H4ck1ng%2C+L3%40rn1ng%2C+8logg1ng+%40nd+%24tuff&url=https%3A%2F%2Fcoppertop-6.github.io%2F%2Fposts%2FExecutingCode%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Executing+Unmanaged+Code+in+Memory+-+H4ck1ng%2C+L3%40rn1ng%2C+8logg1ng+%40nd+%24tuff&u=https%3A%2F%2Fcoppertop-6.github.io%2F%2Fposts%2FExecutingCode%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fcoppertop-6.github.io%2F%2Fposts%2FExecutingCode%2F&text=Executing+Unmanaged+Code+in+Memory+-+H4ck1ng%2C+L3%40rn1ng%2C+8logg1ng+%40nd+%24tuff" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Process_Injection/">Remote Process Injection</a><li><a href="/posts/JWT/">Testing JWTs</a><li><a href="/posts/Windows_Dropper/">Creating a Dropper in C</a><li><a href="/posts/AuthbypassIDOR/">Difference Between IDOR and Authorization Bypass</a><li><a href="/posts/ExecutingCode/">Executing Unmanaged Code in Memory</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/code-execution/">code_execution</a> <a class="post-tag" href="/tags/auth-bypass/">auth_bypass</a> <a class="post-tag" href="/tags/blackhat/">blackhat</a> <a class="post-tag" href="/tags/defcon/">defcon</a> <a class="post-tag" href="/tags/idor/">idor</a> <a class="post-tag" href="/tags/jwt/">jwt</a> <a class="post-tag" href="/tags/plans/">plans</a> <a class="post-tag" href="/tags/tokens/">tokens</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Windows_Dropper/"><div class="card-body"> <em class="small" data-ts="1676826000" data-df="ll" > Feb 19, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Creating a Dropper in C</h3><div class="text-muted small"><p> In this post we will take a very high level approach to creating a dropper for Windows. The structure of the dropper can take the form of 3 templates, each using a different structure of the portab...</p></div></div></a></div><div class="card"> <a href="/posts/Process_Injection/"><div class="card-body"> <em class="small" data-ts="1678813200" data-df="ll" > Mar 14, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Remote Process Injection</h3><div class="text-muted small"><p> What is process injection and why do we need it? Process injection is the act of creating a copy of your shellcode in the current process and copying it across to the memory space of a different p...</p></div></div></a></div><div class="card"> <a href="/posts/BH25D30/"><div class="card-body"> <em class="small" data-ts="1661187600" data-df="ll" > Aug 22, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>BlackHat 2022</h3><div class="text-muted small"><p> My BlackHat and Decfon 2022 experience. In 2022 I once again got the opportunity to attend BlackHat and Defcon. I managed to also attend a two day Applied Web Application Hacking training course p...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Blog/" class="btn btn-outline-primary" prompt="Older"><p>2023 Plans</p></a> <a href="/posts/AuthbypassIDOR/" class="btn btn-outline-primary" prompt="Newer"><p>Difference Between IDOR and Authorization Bypass</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/coppertop109">TBA</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/code-execution/">code_execution</a> <a class="post-tag" href="/tags/auth-bypass/">auth_bypass</a> <a class="post-tag" href="/tags/blackhat/">blackhat</a> <a class="post-tag" href="/tags/defcon/">defcon</a> <a class="post-tag" href="/tags/idor/">idor</a> <a class="post-tag" href="/tags/jwt/">jwt</a> <a class="post-tag" href="/tags/plans/">plans</a> <a class="post-tag" href="/tags/tokens/">tokens</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
